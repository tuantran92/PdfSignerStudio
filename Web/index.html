<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        :root {
            --bg: #F5F5F5;
            --panel: #FFFFFF;
            --text: #0f172a;
            --border: #EAEAEA;
            --shadow: 0 2px 8px rgba(0,0,0,.1);
            --accent: #2563eb;
        }

        body {
            background-color: var(--bg);
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
            color: var(--text);
        }

        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            user-select: none;
        }

        #container {
            position: relative;
            z-index: 1;
            width: 100%;
            margin-top: 70px;
            height: calc(100% - 70px);
            padding-top: 0;
            overflow: auto;
            box-sizing: border-box;
        }

        #pagewrap {
            position: relative;
            margin: 20px auto 24px auto;
            width: fit-content;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,.1);
        }

        .page-container {
            position: absolute;
            top: 0;
            left: 0;
            background: #fff;
            box-shadow: 0 0 20px rgba(0,0,0,.08);
            transition: opacity 250ms ease-in-out;
        }

        #overlay {
            position: absolute;
            left: 0;
            top: 0;
            pointer-events: auto;
        }

        .box {
            position: absolute;
            box-sizing: border-box;
            scroll-margin-top: 100px;
            scroll-margin-bottom: 100px;
        }

            .box.req {
                border: 2px solid var(--accent);
            }

            .box.nreq {
                border: 2px dashed #888;
            }

            .box.sel {
                outline: 3px solid var(--accent);
                z-index: 2;
            }

        .handle {
            background: var(--accent);
        }

        #left-panel, #thumbbar {
            position: fixed;
            top: 70px;
            bottom: 12px;
            background: var(--panel);
            box-shadow: var(--shadow);
            border-radius: 12px;
            padding: 15px;
            z-index: 9999;
            font-size: 13px;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border);
        }

        #thumbbar {
            right: 12px;
            width: 180px;
            overflow-y: auto;
        }

        #left-panel {
            left: 12px;
            width: 220px;
        }

            #left-panel.dragover {
                box-shadow: 0 0 0 3px var(--accent), 0 2px 12px rgba(0,0,0,.25);
            }

        #left-panel-main-content {
            overflow-y: auto;
            flex-grow: 1;
        }

        #left-panel h3, #thumbbar h3 {
            margin: 0 0 8px 0;
            font-size: 14px;
            font-weight: 600;
            flex-shrink: 0;
            color: var(--accent);
        }

        #thumblist {
            overflow-y: auto;
        }

        .panel-divider {
            border: none;
            border-top: 1px solid var(--border);
            margin: 15px 0;
        }

        #addedfieldslist .field-item {
            padding: 8px 6px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            border-radius: 6px;
            margin-bottom: 2px;
            font-size: 13px;
            transition: background-color 0.2s ease;
        }

            #addedfieldslist .field-item:hover {
                background-color: rgba(37, 99, 235, 0.08);
            }

        .btn-sm {
            font-size: 13px;
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: #fff;
            cursor: pointer;
            transition: all 0.2s ease;
        }

            .btn-sm:hover {
                background: #f7faff;
                border-color: var(--accent);
                color: var(--accent);
            }

        #btnNewTpl {
            background-color: rgba(37, 99, 235, 0.1);
            border-color: rgba(37, 99, 235, 0.2);
            color: var(--accent);
            font-weight: 600;
        }

            #btnNewTpl:hover {
                background-color: rgba(37, 99, 235, 0.2);
            }

        .tpl {
            position: relative;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 8px;
            margin: 8px 0;
            cursor: grab;
            background: #fdfdfd;
            transition: background-color 0.2s ease, border-color 0.2s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

            .tpl:hover {
                background: #f7faff;
                border-color: var(--accent);
            }

        .tpl-name {
            flex-grow: 1;
        }

        .tpl .icon-btn {
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease, visibility 0.2s ease;
        }

        .tpl:hover .icon-btn {
            opacity: 0.7;
            visibility: visible;
        }

        .tpl .icon-btn:hover {
            opacity: 1;
        }

        .tpl-preview {
            position: relative;
            width: 60px;
            height: 40px;
            border: 1px solid #e0e0e0;
            background-color: #f9f9f9;
            flex-shrink: 0;
            border-radius: 2px;
            overflow: hidden;
        }

        .preview-box {
            position: absolute;
            background-color: rgba(37, 99, 235, 0.5);
            border: 1px solid rgba(37, 99, 235, 0.8);
            border-radius: 1px;
            box-sizing: border-box;
        }

        .icon-edit {
            right: 32px;
        }

        .icon-del {
            right: 8px;
        }

        .thumb {
            position: relative;
            border: 2px solid transparent;
            border-radius: 8px;
            margin: 10px 0;
            cursor: pointer;
            overflow: hidden;
            line-height: 0;
            transition: border-color 0.2s ease;
        }

            .thumb:hover {
                border-color: rgba(37, 99, 235, 0.5);
            }

            .thumb canvas, .thumb img {
                width: 100%;
                height: auto;
                display: block;
                border-radius: 6px;
            }

            .thumb.cur {
                border-color: var(--accent);
            }

            .thumb .pnum {
                position: absolute;
                bottom: 6px;
                left: 50%;
                transform: translateX(-50%);
                background-color: rgba(37, 99, 235, 0.75);
                color: white;
                font-size: 12px;
                font-weight: bold;
                padding: 2px 10px;
                border-radius: 12px;
                line-height: 1.5;
                transition: all 0.2s ease-in-out;
            }

            .thumb:hover .pnum {
                transform: translateX(-50%) scale(1.08);
                background-color: rgba(37, 99, 235, 0.9);
            }

        .icon-btn:hover svg {
            stroke: var(--accent);
        }

        #top-toolbar {
            position: fixed;
            top: 10px;
            left: 0;
            transform: translateX(-50%);
            z-index: 10000;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(8px);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,.15);
            padding: 6px;
            display: none;
            align-items: center;
            gap: 4px;
            border: 1px solid rgba(0,0,0,0.08);
        }

        .toolbar-divider {
            width: 1px;
            height: 24px;
            background-color: #e0e0e0;
            margin: 0 4px;
        }

        .btn-tool {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            padding: 0;
            border: none;
            border-radius: 8px;
            background: transparent;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

            .btn-tool:hover {
                background-color: #e8e8e8;
            }

            .btn-tool svg {
                width: 20px;
                height: 20px;
                stroke-width: 1.5;
                color: #333;
            }

        .page-container.visible {
            opacity: 1;
            z-index: 1;
        }

        .page-container.hidden {
            opacity: 0;
            z-index: 0;
            pointer-events: none;
        }

        .handle {
            position: absolute;
            width: 10px;
            height: 10px;
            border: 2px solid #fff;
            box-sizing: border-box;
            border-radius: 3px;
        }

            .handle.tl {
                left: -6px;
                top: -6px;
                cursor: nwse-resize;
            }

            .handle.tr {
                right: -6px;
                top: -6px;
                cursor: nesw-resize;
            }

            .handle.bl {
                left: -6px;
                bottom: -6px;
                cursor: nesw-resize;
            }

            .handle.br {
                right: -6px;
                bottom: -6px;
                cursor: nwse-resize;
            }

        #selection-actions {
            margin-top: auto;
            padding-top: 10px;
            border-top: 1px solid #eee;
            flex-shrink: 0;
        }

        #tplhdr {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        #addedfieldslist .empty-state {
            color: #888;
            padding-top: 8px;
        }

        #tplModal {
            position: fixed;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,.25);
            z-index: 100000;
        }

        #tplPanel {
            width: 640px;
            max-height: 80vh;
            overflow: auto;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,.25);
            padding: 16px;
            font: 13px system-ui,Segoe UI,Roboto,Arial;
        }

            #tplPanel h3 {
                margin: 0 0 12px 0;
                color: var(--text) !important;
            }

        #tplForm label {
            display: block;
            margin: 8px 0 4px;
        }

        #tplItemsTable {
            width: 100%;
            border-collapse: collapse;
            margin-top: 8px;
        }

            #tplItemsTable th, #tplItemsTable td {
                border: 1px solid #eee;
                padding: 6px;
                text-align: left;
            }

            #tplItemsTable input[type="text"], #tplItemsTable input[type="number"] {
                width: 100%;
                box-sizing: border-box;
            }

        #tplBtns {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 12px;
        }

        .icon-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid transparent;
            border-radius: 6px;
            background: transparent;
            opacity: .7;
            cursor: pointer;
            padding: 0;
        }

            .icon-btn svg {
                transition: stroke 0.2s ease;
            }

        .icon-edit {
            right: 36px;
        }

        .icon-del {
            right: 8px;
        }

        .icon-btn svg {
            width: 16px;
            height: 16px;
            stroke: #555;
        }

        .icon-del svg {
            stroke: #b00020;
        }

        #ghost {
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 10;
        }

        .ghost-box {
            position: absolute;
            box-sizing: border-box;
            border: 2px dashed var(--accent);
            background: rgba(37, 99, 235,.08);
            border-radius: 6px;
        }

            .ghost-box > span {
                position: absolute;
                left: 50%;
                top: 50%;
                transform: translate(-50%,-50%);
                font: 12px system-ui,Segoe UI,Roboto,Arial;
                color: #0d47a1;
                background: rgba(255,255,255,.7);
                padding: 1px 6px;
                border-radius: 6px;
                white-space: nowrap;
                max-width: 100%;
                overflow: hidden;
                text-overflow: ellipsis;
            }

        #grid-overlay {
            position: absolute;
            pointer-events: none;
            z-index: 10;
            inset: 0;
        }

        #btn-undo, #btn-redo {
            display: none !important;
        }

        .field-group {
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 6px;
            overflow: hidden;
            background-color: #fff;
        }

        .field-group-header {
            padding: 8px 10px;
            background-color: #f7f9fc;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            user-select: none;
            transition: background-color 0.2s ease;
        }

            .field-group-header:hover {
                background-color: #f0f2f5;
            }

        .toggle-icon {
            display: inline-block;
            margin-right: 8px;
            transition: transform 0.2s ease-in-out;
            font-size: 10px;
            line-height: 1;
        }

        .field-group-content {
            padding: 0 5px 5px 5px;
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out, padding 0.3s ease-in-out;
        }

        .field-group.collapsed .field-group-content {
            max-height: 0;
            padding-top: 0;
            padding-bottom: 0;
            border-top: none;
        }

        .field-group.collapsed .toggle-icon {
            transform: rotate(-90deg);
        }

        #addedfieldslist .field-item {
            margin: 4px 4px 0 4px;
            border-radius: 4px;
        }

            #addedfieldslist .field-item:first-child {
                margin-top: 5px;
            }

        #context-menu {
            position: fixed;
            z-index: 10001;
            display: none;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            border: 1px solid #eee;
            padding: 6px;
            min-width: 180px;
        }

            #context-menu ul {
                list-style: none;
                margin: 0;
                padding: 0;
            }

            #context-menu li {
                padding: 8px 12px;
                cursor: pointer;
                border-radius: 6px;
                display: flex;
                align-items: center;
                gap: 10px;
                font-size: 13px;
                transition: background-color 0.15s ease;
            }

                #context-menu li:hover {
                    background-color: #f0f2f5;
                }

                #context-menu li svg {
                    width: 16px;
                    height: 16px;
                    stroke-width: 1.5;
                }

                #context-menu li.separator {
                    height: 1px;
                    background-color: #eee;
                    margin: 4px 0;
                    padding: 0;
                }

                #context-menu li.danger {
                    color: #d32f2f;
                }

                    #context-menu li.danger:hover {
                        background-color: #ffebee;
                    }

                    #context-menu li.danger svg {
                        stroke: #d32f2f;
                    }
    </style>
</head>
<body>
    <div id="top-toolbar">
        <button title="Match Width" class="btn-tool" id="btn-match-w"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12H3M21 3H3M21 21H3M12 21V3" /></svg></button>
        <button title="Match Height" class="btn-tool" id="btn-match-h"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M12 21V3M21 12H3M21 3H3M21 21H3" /></svg></button>
        <button title="Match Size" class="btn-tool" id="btn-match-wh"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" /></svg></button>
        <button title="Undo" class="btn-tool" id="btn-undo"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7v6h6" /><path d="M21 13a9 9 0 0 0-9-9 9 9 0 0 0-9 9" /></svg></button>
        <button title="Redo" class="btn-tool" id="btn-redo"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M21 7v6h-6" /><path d="M3 13a9 9 0 0 1 9-9 9 9 0 0 1 9 9" /></svg></button>
        <div class="toolbar-divider"></div>
        <button title="Align Left" class="btn-tool" id="btn-align-left"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><line x1="4" y1="21" x2="4" y2="3" /><rect x="8" y="6" width="8" height="6" rx="1" /><rect x="8" y="14" width="12" height="6" rx="1" /></svg></button>
        <button title="Align Horizontal Center" class="btn-tool" id="btn-align-h-center"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="21" x2="12" y2="3" /><rect x="6" y="6" width="12" height="6" rx="1" /><rect x="8" y="14" width="8" height="6" rx="1" /></svg></button>
        <button title="Align Right" class="btn-tool" id="btn-align-right"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><line x1="20" y1="21" x2="20" y2="3" /><rect x="8" y="6" width="8" height="6" rx="1" /><rect x="4" y="14" width="12" height="6" rx="1" /></svg></button>
        <div class="toolbar-divider"></div>
        <button title="Align Top" class="btn-tool" id="btn-align-top"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="4" x2="21" y2="4" /><rect x="6" y="8" width="6" height="8" rx="1" /><rect x="14" y="8" width="6" height="12" rx="1" /></svg></button>
        <button title="Align Vertical Center" class="btn-tool" id="btn-align-v-center"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12" /><rect x="6" y="6" width="6" height="12" rx="1" /><rect x="14" y="8" width="6" height="8" rx="1" /></svg></button>
        <button title="Align Bottom" class="btn-tool" id="btn-align-bottom"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="20" x2="21" y2="20" /><rect x="6" y="4" width="6" height="12" rx="1" /><rect x="14" y="8" width="6" height="8" rx="1" /></svg></button>
        <div class="toolbar-divider"></div>
        <button title="Distribute Horizontally" class="btn-tool" id="btn-dist-h"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><line x1="4" y1="12" x2="20" y2="12" /><rect x="6" y="5" width="4" height="14" rx="1" /><rect x="14" y="5" width="4" height="14" rx="1" /></svg></button>
        <button title="Distribute Vertically" class="btn-tool" id="btn-dist-v"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="4" x2="12" y2="20" /><rect x="5" y="6" width="14" height="4" rx="1" /><rect x="5" y="14" width="14" height="4" rx="1" /></svg></button>
    </div>

    <div id="left-panel">
        <div id="left-panel-main-content">
            <div id="tplhdr">
                <h3>Templates</h3>
                <button id="btnNewTpl" class="btn-sm">New</button>
            </div>
            <div id="tpllist">Loading…</div>
            <hr class="panel-divider">
            <h3>Added Fields</h3>
            <div id="addedfieldslist">
            </div>
        </div>
        <div id="selection-actions" style="display: none;">
            <button id="btnCreateFromSelection" class="btn-sm" style="width: 100%; padding: 8px;">Create Template from Selection</button>
        </div>
    </div>

    <div id="thumbbar"><h3>Pages</h3><div id="thumblist">Loading…</div></div>

    <div id="container">
        <div id="pagewrap">
            <canvas id="grid-overlay"></canvas>
        </div>
    </div>

    <div id="tplModal">
        <div id="tplPanel">
            <h3 id="tplTitle">Template</h3>
            <div id="tplForm">
                <label>Template Name</label>
                <input id="tplName" type="text" placeholder="e.g. Director + Accountant" />
                <table id="tplItemsTable">
                    <thead>
                        <tr><th>Name</th><th>W (pt)</th><th>H (pt)</th><th>Req</th><th>dx</th><th>dy</th><th></th></tr>
                    </thead>
                    <tbody id="tplItemsBody"></tbody>
                </table>
                <div style="margin-top:8px">
                    <button id="btnAddItem" class="btn-sm">Add item</button>
                </div>
            </div>
            <div id="tplBtns">
                <button id="btnTplDelete" class="btn-sm" style="margin-right:auto;color:#b00020">Delete</button>
                <button id="btnTplCancel" class="btn-sm">Cancel</button>
                <button id="btnTplSave" class="btn-sm">Save</button>
            </div>
        </div>
    </div>

    <div id="context-menu">
        <ul>
            <li data-action="rename"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9" /><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z" /></svg> Rename</li>
        </ul>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        let pdfDoc = null, pageNum = 1, scale = 1.25;
        let viewport = null;

        const pageWrap = document.getElementById('pagewrap');
        let overlay;

        const container = document.getElementById('container');
        const thumbList = document.getElementById('thumblist');
        let thumbCanvases = [];

        let pageCache = {};
        let isFlipping = false;
        let flipScrollTarget = null;

        let gridPt = 8, MIN_GRID_CELLS = 3;

        let fields = [], selectedIds = [], dragging = null, editingId = null;
        let templatesUi = [];
        let isNativeDragging = false;
        let currentDragDataType = null;
        let currentTplDrag = null;
        let ghostWrap = null;

        let contextMenuTargetId = null;

        function ensureGhost() {
            if (!overlay) return;
            if (!ghostWrap || !overlay.contains(ghostWrap)) {
                if (ghostWrap) ghostWrap.remove();
                ghostWrap = document.createElement('div');
                ghostWrap.id = 'ghost';
                overlay.appendChild(ghostWrap);
            }
            ghostWrap.innerHTML = '';
        }
        function clearGhost() { if (ghostWrap) { ghostWrap.remove(); ghostWrap = null; } }
        function drawGhostTemplate(tpl, x, y) {
            if (!tpl || !viewport) return;
            ensureGhost();
            for (const it of tpl.items) {
                const s = {
                    left: x + ptToPx(it.dx),
                    top: y + ptToPx(it.dy),
                    width: ptToPx(it.w),
                    height: ptToPx(it.h)
                };
                const b = document.createElement('div');
                b.className = 'ghost-box';
                Object.assign(b.style, { left: s.left + 'px', top: s.top + 'px', width: s.width + 'px', height: s.height + 'px' });
                const lbl = document.createElement('span');
                lbl.textContent = it.name ?? 'Signature';
                b.appendChild(lbl);
                ghostWrap.appendChild(b);
            }
        }
        function ptToPx(v) { return v * scale; }
        function pxToPt(v) { return v / scale; }
        function pageHeightPt() { return viewport.height / scale; }
        function gridPx() { return Math.max(4, Math.round(ptToPx(gridPt))); }
        function applyGridBg() { if (overlay) overlay.style.setProperty('--grid', gridPx() + 'px'); }

        function post(msg) { chrome.webview.postMessage(JSON.stringify(msg)); }

        async function renderPageToCache(num) {
            if (pageCache[num]) return pageCache[num];
            const page = await pdfDoc.getPage(num);
            const pageViewport = page.getViewport({ scale });
            const offscreenCanvas = document.createElement('canvas');
            offscreenCanvas.width = pageViewport.width;
            offscreenCanvas.height = pageViewport.height;
            const offscreenCtx = offscreenCanvas.getContext('2d');
            await page.render({ canvasContext: offscreenCtx, viewport: pageViewport }).promise;
            const cacheEntry = { canvas: offscreenCanvas, viewport: pageViewport };
            pageCache[num] = cacheEntry;
            return cacheEntry;
        }

        function preloadAdjacentPages(num) {
            setTimeout(() => {
                const pagesToLoad = [num - 1, num + 1];
                for (const pageNumToLoad of pagesToLoad) {
                    if (pageNumToLoad > 0 && pageNumToLoad <= pdfDoc.numPages && !pageCache[pageNumToLoad]) {
                        renderPageToCache(pageNumToLoad).catch(err => console.error(`Failed to pre-render page ${pageNumToLoad}`, err));
                    }
                }
            }, 100);
        }

        async function displayPage(num) {
            const cacheEntry = pageCache[num] || await renderPageToCache(num);
            viewport = cacheEntry.viewport;

            const oldPage = pageWrap.querySelector('.page-container.visible');
            const newPage = document.createElement('div');
            newPage.className = 'page-container hidden';

            const pageCanvas = cacheEntry.canvas;
            newPage.appendChild(pageCanvas);

            if (!overlay) {
                overlay = createOverlay();
            }
            newPage.appendChild(overlay);

            pageWrap.appendChild(newPage);

            pageWrap.style.width = viewport.width + 'px';
            pageWrap.style.height = viewport.height + 'px';

            post({ type: 'meta', numPages: pdfDoc.numPages, page: num });
            markCurrentThumb(num);
            applyGridBg();
            redraw();
            updateSelectionActions();

            setTimeout(() => {
                if (oldPage) {
                    oldPage.classList.remove('visible');
                    oldPage.classList.add('hidden');
                }
                newPage.classList.add('visible');
                newPage.classList.remove('hidden');

                if (oldPage) {
                    setTimeout(() => oldPage.remove(), 250);
                }
            }, 10);

            if (flipScrollTarget === 'top') container.scrollTop = 1;
            else if (flipScrollTarget === 'bottom') container.scrollTop = Math.max(0, container.scrollHeight - container.clientHeight - 1);
            flipScrollTarget = null;

            preloadAdjacentPages(num);
        }

        window.setPage = async function (num) {
            if (isFlipping || num === pageNum) return;
            isFlipping = true;
            pageNum = Math.min(Math.max(1, num), pdfDoc.numPages);
            selectedIds = [];
            updateSelectionActions();
            await displayPage(pageNum);
            isFlipping = false;
        };

        function createOverlay() {
            const ov = document.createElement('div');
            ov.id = 'overlay';
            ov.tabIndex = 0;

            ov.addEventListener('mousedown', handleMouseDown);
            ov.addEventListener('mousemove', handleMouseMove);
            ov.addEventListener('keydown', handleKeyDown);
            ov.addEventListener('dblclick', handleDoubleClick);
            ov.addEventListener('contextmenu', showContextMenu);

            ['dragenter', 'dragover'].forEach(type => ov.addEventListener(type, handleOverlayDragOver));
            ov.addEventListener('drop', handleOverlayDrop);
            ov.addEventListener('dragleave', handleOverlayDragLeave);
            ov.addEventListener('wheel', handleWheel, { passive: false });

            let lastMove = 0;
            ov.addEventListener('mousemove', e => {
                if (Date.now() - lastMove < 50) return;
                lastMove = Date.now();
                const rect = overlay.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                const Hpt = pageHeightPt();
                const xpt = pxToPt(x);
                const ypt = Hpt - pxToPt(y);
                post({ type: 'mouseMove', pt: { x: xpt, y: ypt } });
            });
            ov.addEventListener('mouseleave', e => {
                post({ type: 'mouseMove', pt: { x: 0, y: 0 } });
            });

            return ov;
        }

        async function buildThumbs() {
            thumbList.innerHTML = '';
            thumbCanvases = [];
            const desiredWidth = 140;

            for (let i = 1; i <= pdfDoc.numPages; i++) {
                const page = await pdfDoc.getPage(i);
                const vp0 = page.getViewport({ scale: 1 });
                const scaleT = desiredWidth / vp0.width;
                const vp = page.getViewport({ scale: scaleT });

                const cv = document.createElement('canvas');
                cv.width = vp.width; cv.height = vp.height;
                const cctx = cv.getContext('2d');
                cctx.fillStyle = 'white'; cctx.fillRect(0, 0, cv.width, cv.height);
                await page.render({ canvasContext: cctx, viewport: vp }).promise;

                const item = document.createElement('div');
                item.className = 'thumb'; item.dataset.page = i;
                item.appendChild(cv);

                const pspan = document.createElement('div');
                pspan.className = 'pnum'; pspan.textContent = i;
                item.appendChild(pspan);

                item.addEventListener('click', () => { flipScrollTarget = 'top'; window.setPage(i); });
                thumbList.appendChild(item);
                thumbCanvases.push(cv);
            }
            markCurrentThumb(pageNum);
        }
        function markCurrentThumb(n) {
            document.querySelectorAll('.thumb').forEach(el => el.classList.remove('cur'));
            const el = document.querySelector(`.thumb[data-page="${n}"]`);
            if (el) {
                el.classList.add('cur');
                if (el.scrollIntoView) el.scrollIntoView({ block: 'nearest' });
            }
        }

        function beginEditName(id) {
            if (selectedIds.length !== 1 || selectedIds[0] !== id) return;

            const f = fields.find(t => t.id === id); if (!f) return;
            if (editingId && document.getElementById('nameEditor')) {
                document.getElementById('nameEditor').remove();
                editingId = null;
            }
            const box = overlay.querySelector(`.box[data-id="${id}"]`); if (!box) return;

            const cx = box.offsetLeft + box.offsetWidth / 2, cy = box.offsetTop + box.offsetHeight / 2;
            const w = Math.max(60, Math.min(260, box.offsetWidth - 12));
            const input = document.createElement('input');
            input.id = 'nameEditor'; input.type = 'text'; input.value = f.name;
            Object.assign(input.style, {
                position: 'absolute', left: cx + 'px', top: cy + 'px', transform: 'translate(-50%,-50%)',
                width: w + 'px', padding: '4px 8px', fontFamily: 'system-ui,Segoe UI,Roboto,Arial',
                fontSize: '12px', background: '#fff', border: '1px solid #1976d2', borderRadius: '8px',
                boxShadow: '0 2px 8px rgba(0,0,0,.12)', zIndex: 2147483647
            });
            overlay.appendChild(input);
            editingId = id; input.focus(); input.select();

            function commit() {
                if (!document.getElementById('nameEditor')) return;
                const newName = input.value.trim();
                input.remove(); editingId = null;
                if (newName && newName !== f.name) {
                    post({ type: 'renameField', id: f.id, name: newName, page: pageNum });
                } else { redraw(); }
            }
            function cancel() { if (document.getElementById('nameEditor')) { input.remove(); editingId = null; redraw(); } }
            input.addEventListener('keydown', e => {
                if (e.key === 'Enter') { e.preventDefault(); commit(); }
                if (e.key === 'Escape') { e.preventDefault(); cancel(); }
                e.stopPropagation();
            });
            input.addEventListener('blur', () => commit());
        }

        function redraw() {
            if (!overlay || !viewport) return;
            overlay.innerHTML = '';
            ghostWrap = null;

            const Hpt = pageHeightPt();
            overlay.style.width = viewport.width + 'px';
            overlay.style.height = viewport.height + 'px';

            fields.forEach(f => {
                const div = document.createElement('div');
                div.className = 'box ' + (f.required ? 'req' : 'nreq') + (selectedIds.includes(f.id) ? ' sel' : '');
                const xpx = ptToPx(f.x), wpx = ptToPx(f.w), hpx = ptToPx(f.h);
                const ypx = ptToPx(Hpt - f.y - f.h);
                Object.assign(div.style, { left: xpx + 'px', top: ypx + 'px', width: wpx + 'px', height: hpx + 'px' });
                div.title = f.name; div.dataset.id = f.id;

                div.draggable = true;

                const lbl = document.createElement('span');
                lbl.textContent = f.name;
                Object.assign(lbl.style, {
                    position: 'absolute', left: '50%', top: '50%', transform: 'translate(-50%,-50%)', padding: '2px 6px',
                    fontFamily: 'system-ui,Segoe UI,Roboto,Arial', fontSize: '12px', fontWeight: 'bold', background: 'rgba(255,255,255,.7)',
                    borderRadius: '6px', pointerEvents: 'none', maxWidth: '100%', whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis'
                });
                div.appendChild(lbl);

                if (selectedIds.length > 0 && f.id === selectedIds[selectedIds.length - 1]) {
                    ['tl', 'tr', 'bl', 'br'].forEach(pos => { const h = document.createElement('div'); h.className = 'handle ' + pos; h.dataset.id = f.id; h.dataset.pos = pos; div.appendChild(h); });
                }
                overlay.appendChild(div);
            });
            overlay.focus();
        }

        function handleMouseDown(e) {
            if (isNativeDragging || editingId) return;
            const rect = overlay.getBoundingClientRect();
            const x = e.clientX - rect.left, y = e.clientY - rect.top;
            const t = e.target;

            if (t.classList.contains('handle')) {
                const id = t.dataset.id; const corner = t.dataset.pos || 'br';
                const f = fields.find(i => i.id === id); if (!f) return;
                dragging = { mode: 'resize', id: id, corner, sx: x, sy: y, startRect: { ...f } };
                overlay.focus(); e.preventDefault(); return;
            }

            const box = t.closest('.box');
            if (box) {
                const id = box.dataset.id;
                if (e.shiftKey) {
                    if (selectedIds.includes(id)) {
                        selectedIds = selectedIds.filter(sid => sid !== id);
                    } else {
                        selectedIds.push(id);
                    }
                } else {
                    if (!selectedIds.includes(id)) {
                        selectedIds = [id];
                    }
                }

                dragging = {
                    mode: 'move',
                    sx: x, sy: y,
                    startRects: fields.filter(f => selectedIds.includes(f.id)).map(f => ({ ...f }))
                };
                redraw();
                updateSelectionActions();
                overlay.focus();
                return;
            }

            selectedIds = [];
            redraw();
            updateSelectionActions();
            dragging = { mode: 'draw', sx: x, sy: y, startRect: null, moved: false };
            const draft = document.createElement('div');
            draft.className = 'box req';
            Object.assign(draft.style, { left: x + 'px', top: y + 'px', width: '0px', height: '0px' });
            draft.id = 'draft';
            overlay.appendChild(draft); overlay.focus();
        }

        function handleMouseMove(e) {
            if (isNativeDragging || !dragging) return;
            const rect = overlay.getBoundingClientRect();
            let x = e.clientX - rect.left, y = e.clientY - rect.top;

            if (dragging.mode === 'draw') {
                const draft = document.getElementById('draft');
                if (!draft) return;
                let left = Math.min(dragging.sx, x), top = Math.min(dragging.sy, y);
                let w = Math.abs(x - dragging.sx), h = Math.abs(y - dragging.sy);
                dragging.moved ||= (w > 2 || h > 2);
                Object.assign(draft.style, { left: left + 'px', top: top + 'px', width: w + 'px', height: h + 'px' });
                return;
            }

            if (dragging.mode === 'move') {
                const dx = x - dragging.sx, dy = y - dragging.sy;
                dragging.startRects.forEach(startRect => {
                    const f = fields.find(field => field.id === startRect.id);
                    if (f) {
                        f.x = startRect.x + pxToPt(dx);
                        f.y = startRect.y - pxToPt(dy);
                    }
                });
                redraw();
                return;
            }

            if (dragging.mode === 'resize') {
                const f0 = dragging.startRect;
                const Hpt0 = pageHeightPt();
                const l0 = ptToPx(f0.x), t0 = ptToPx(Hpt0 - f0.y - f0.h), w0 = ptToPx(f0.w), h0 = ptToPx(f0.h);
                let l = l0, t = t0, w = Math.max(1, w0), h = Math.max(1, h0);
                const corner = dragging.corner || 'br';
                if (corner === 'br') { w = Math.max(1, x - l0); h = Math.max(1, y - t0); }
                else if (corner === 'tr') { w = Math.max(1, x - l0); t = Math.min(y, t0 + h0 - 1); h = Math.max(1, (t0 + h0) - t); }
                else if (corner === 'bl') { l = Math.min(x, l0 + w0 - 1); w = Math.max(1, (l0 + w0) - l); h = Math.max(1, y - t0); }
                else { l = Math.min(x, l0 + w0 - 1); t = Math.min(y, t0 + h0 - 1); w = Math.max(1, (l0 + w0) - l); h = Math.max(1, (t0 + h0) - t); }

                const f = fields.find(t => t.id === dragging.id);
                if (f) { f.x = pxToPt(l); f.y = Hpt0 - pxToPt(t) - pxToPt(h); f.w = pxToPt(w); f.h = pxToPt(h); redraw(); }
                return;
            }
        }

        window.addEventListener('mouseup', e => {
            if (!dragging) return;
            if (dragging.mode === 'draw') {
                const draft = document.getElementById('draft');
                if (draft) {
                    const xpx = parseFloat(draft.style.left), ypx = parseFloat(draft.style.top);
                    const wpx = parseFloat(draft.style.width), hpx = parseFloat(draft.style.height);
                    const minPx = MIN_GRID_CELLS * gridPx();
                    if (!dragging.moved || wpx < minPx || hpx < minPx) { draft.remove(); dragging = null; return; }
                    draft.remove();
                    const Hpt = pageHeightPt();
                    const xpt = pxToPt(xpx), wpt = pxToPt(wpx), hpt = pxToPt(hpx);
                    const ypt = Hpt - pxToPt(ypx) - hpt;
                    post({ type: 'addField', page: pageNum, rect: { x: xpt, y: ypt, w: wpt, h: hpt, required: true } });
                }
                dragging = null; return;
            }

            const itemsToUpdate = dragging.mode === 'move' ? dragging.startRects : [dragging.startRect];
            itemsToUpdate.forEach(item => {
                const f = fields.find(t => t.id === item.id);
                if (f) post({ type: 'updateField', id: f.id, page: pageNum, rect: { x: f.x, y: f.y, w: f.w, h: f.h } });
            });
            dragging = null;
        });

        function handleKeyDown(e) {
            if (editingId) return;
            if (e.key === 'PageDown' && pdfDoc.numPages) {
                flipScrollTarget = 'top'; window.setPage(pageNum + 1); e.preventDefault(); return;
            }
            if (e.key === 'PageUp' && pageNum > 1) {
                flipScrollTarget = 'bottom'; window.setPage(pageNum - 1); e.preventDefault(); return;
            }

            if (selectedIds.length === 0) return;

            const stepPt = e.shiftKey ? 5 : 1;
            if (['ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown'].includes(e.key)) {
                e.preventDefault();
                fields.forEach(f => {
                    if (selectedIds.includes(f.id)) {
                        if (e.key === 'ArrowLeft') f.x -= stepPt; if (e.key === 'ArrowRight') f.x += stepPt;
                        if (e.key === 'ArrowUp') f.y += stepPt; if (e.key === 'ArrowDown') f.y -= stepPt;
                        post({ type: 'updateField', id: f.id, page: pageNum, rect: { x: f.x, y: f.y, w: f.w, h: f.h } });
                    }
                });
                redraw();
            }

            if (e.key.toLowerCase() === 'r') {
                e.preventDefault();
                selectedIds.forEach(id => post({ type: 'toggleRequired', id: id, page: pageNum }));
            }
            if (e.key === 'Delete') {
                e.preventDefault();
                selectedIds.forEach(id => post({ type: 'deleteField', id: id, page: pageNum }));
            }
            if ((e.key === 'Enter' || e.key === 'F2') && selectedIds.length === 1) {
                beginEditName(selectedIds[0]); e.preventDefault();
            }
        }
        function handleDoubleClick(e) {
            const box = e.target.closest && e.target.closest('.box'); if (!box) return;
            const id = box.dataset.id; if (!id) return;
            e.preventDefault(); e.stopPropagation();
            if (selectedIds.length === 1 && selectedIds[0] === id) {
                beginEditName(id);
            }
        }

        function handleDragStart(e) {
            isNativeDragging = true;
            const tplEl = e.target.closest('.tpl');
            const boxEl = e.target.closest('.box');

            if (tplEl) {
                currentDragDataType = 'template';
                const tplName = tplEl.querySelector('.tpl-name').textContent;
                const template = templatesUi.find(t => t.name === tplName);
                if (template) {
                    currentTplDrag = template;
                    e.dataTransfer.setData('application/json', JSON.stringify(template));
                    const img = new Image(); img.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==';
                    e.dataTransfer.setDragImage(img, 0, 0);
                }
            } else if (boxEl && selectedIds.includes(boxEl.dataset.id)) {
                currentDragDataType = 'selection';
                const selectedFields = fields.filter(f => selectedIds.includes(f.id));
                e.dataTransfer.setData('application/json', JSON.stringify(selectedFields));

                const ghost = document.createElement('div');
                ghost.style.cssText = 'position: absolute; left: -1000px; padding: 5px 10px; background: rgba(25, 118, 210, 0.8); color: white; border-radius: 8px;';
                ghost.textContent = `Create Template (${selectedIds.length} items)`;
                document.body.appendChild(ghost);
                e.dataTransfer.setDragImage(ghost, 0, 0);
                setTimeout(() => document.body.removeChild(ghost), 0);
            } else {
                e.preventDefault();
            }
        }

        function handleOverlayDragOver(e) {
            if (currentDragDataType === 'template' && currentTplDrag) {
                e.preventDefault(); e.dataTransfer.dropEffect = 'copy';
                const tpl = currentTplDrag;
                const rect = overlay.getBoundingClientRect();
                const x = e.clientX - rect.left, y = e.clientY - rect.top;
                drawGhostTemplate(tpl, x, y);
            }
        }
        function handleOverlayDrop(e) {
            if (currentDragDataType === 'template') {
                e.preventDefault();
                const tpl = JSON.parse(e.dataTransfer.getData('application/json'));
                const rect = overlay.getBoundingClientRect();
                const x = e.clientX - rect.left, y = e.clientY - rect.top;
                const Hpt = pageHeightPt();
                for (const it of tpl.items) {
                    const leftPx = x + ptToPx(it.dx);
                    const topPx = y + ptToPx(it.dy);
                    const xpt = pxToPt(leftPx);
                    const ypt = Hpt - pxToPt(topPx) - it.h;
                    post({ type: 'addField', page: pageNum, name: it.name, rect: { x: xpt, y: ypt, w: it.w, h: it.h, required: !!it.required } });
                }
            }
        }
        function handleOverlayDragLeave(e) {
            if (!e.currentTarget.contains(e.relatedTarget)) clearGhost();
        }

        document.addEventListener('dragend', () => {
            isNativeDragging = false;
            currentDragDataType = null;
            currentTplDrag = null;
            clearGhost();
        });

        function renderTplBar() {
            const list = document.getElementById('tpllist');
            list.innerHTML = '';
            const pencilSvg = `<svg viewBox="0 0 24 24" fill="none" stroke-width="2"><path d="M12 20h9" /><path d="M16.5 3.5l4 4L7 21H3v-4L16.5 3.5z" /></svg>`;
            const trashSvg = `<svg viewBox="0 0 24 24" fill="none" stroke-width="2"><path d="M3 6h18" /><path d="M8 6V4h8v2" /><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6" /><path d="M10 11v6M14 11v6" /></svg>`;
            const esc = s => (s ?? '').replace(/[&<>"]/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;' }[m]));

            templatesUi.forEach(t => {
                const d = document.createElement('div');
                d.className = 'tpl';
                d.draggable = true;

                const previewContainer = document.createElement('div');
                previewContainer.className = 'tpl-preview';

                if (t.items && t.items.length > 0) {
                    const PREVIEW_WIDTH = 60, PREVIEW_HEIGHT = 40, PADDING = 2;
                    let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
                    t.items.forEach(it => {
                        minX = Math.min(minX, it.dx); minY = Math.min(minY, it.dy);
                        maxX = Math.max(maxX, it.dx + it.w); maxY = Math.max(maxY, it.dy + it.h);
                    });
                    const totalWidth = Math.max(1, maxX - minX), totalHeight = Math.max(1, maxY - minY);
                    const scale = Math.min((PREVIEW_WIDTH - PADDING * 2) / totalWidth, (PREVIEW_HEIGHT - PADDING * 2) / totalHeight);
                    t.items.forEach(it => {
                        const box = document.createElement('div');
                        box.className = 'preview-box';
                        box.style.left = `${PADDING + (it.dx - minX) * scale}px`;
                        box.style.top = `${PADDING + (it.dy - minY) * scale}px`;
                        box.style.width = `${Math.max(1, it.w * scale)}px`;
                        box.style.height = `${Math.max(1, it.h * scale)}px`;
                        previewContainer.appendChild(box);
                    });
                }
                d.appendChild(previewContainer);

                const nameDiv = document.createElement('div');
                nameDiv.className = 'tpl-name';
                nameDiv.textContent = esc(t.name);
                d.appendChild(nameDiv);

                const btnEdit = document.createElement('button');
                btnEdit.className = 'icon-btn icon-edit';
                btnEdit.title = 'Edit';
                btnEdit.innerHTML = pencilSvg;
                btnEdit.addEventListener('mousedown', e => e.stopPropagation());
                btnEdit.addEventListener('click', ev => { ev.stopPropagation(); ev.preventDefault(); openTplEditor(structuredClone(t)); });
                d.appendChild(btnEdit);

                const btnDel = document.createElement('button');
                btnDel.className = 'icon-btn icon-del';
                btnDel.title = 'Delete';
                btnDel.innerHTML = trashSvg;
                btnDel.addEventListener('mousedown', e => e.stopPropagation());
                btnDel.addEventListener('click', ev => { ev.stopPropagation(); ev.preventDefault(); if (confirm(`Delete template "${t.name}"?`)) post({ type: 'deleteTemplate', name: t.name }); });
                d.appendChild(btnDel);

                list.appendChild(d);
            });
        }
        const btnNewTpl = document.getElementById('btnNewTpl');
        const tplModal = document.getElementById('tplModal');
        const tplTitle = document.getElementById('tplTitle');
        const tplName = document.getElementById('tplName');
        const tplItemsBody = document.getElementById('tplItemsBody');
        const btnAddItem = document.getElementById('btnAddItem');
        const btnTplSave = document.getElementById('btnTplSave');
        const btnTplCancel = document.getElementById('btnTplCancel');
        const btnTplDelete = document.getElementById('btnTplDelete');
        let editingTemplate = null;
        function openTplEditor(tpl) {
            editingTemplate = tpl || { name: '', items: [] };
            tplTitle.textContent = editingTemplate.name ? `Edit: ${editingTemplate.name}` : 'New Template';
            tplName.value = editingTemplate.name || ''; tplItemsBody.innerHTML = '';
            (editingTemplate.items || []).forEach(addTplItemRow);
            tplModal.style.display = 'flex';
            btnTplDelete.style.display = editingTemplate && templatesUi.some(x => x.name === editingTemplate.name) ? 'inline-block' : 'none';
        }
        function closeTplEditor() { tplModal.style.display = 'none'; editingTemplate = null; }
        function addTplItemRow(item) {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td><input type="text" value="${item?.name ?? 'Signature'}" /></td><td><input type="number" step="0.5" value="${item?.w ?? 120}"/></td><td><input type="number" step="0.5" value="${item?.h ?? 60}"/></td><td style="text-align:center"><input type="checkbox" ${item?.required !== false ? 'checked' : ''}/></td><td><input type="number" step="0.5" value="${item?.dx ?? 0}"/></td><td><input type="number" step="0.5" value="${item?.dy ?? 0}"/></td><td><button class="btn-sm">✕</button></td>`;
            tr.querySelector('button').addEventListener('click', () => tr.remove()); tplItemsBody.appendChild(tr);
        }
        function collectTplItems() {
            return Array.from(tplItemsBody.querySelectorAll('tr')).map(r => {
                const [nameI, wI, hI, reqI, dxI, dyI] = r.querySelectorAll('input');
                return { name: nameI.value.trim() || 'Signature', w: parseFloat(wI.value) || 1, h: parseFloat(hI.value) || 1, required: !!reqI.checked, dx: parseFloat(dxI.value) || 0, dy: parseFloat(dyI.value) || 0 };
            });
        }
        btnNewTpl.addEventListener('click', () => openTplEditor({ name: '', items: [] }));
        btnAddItem.addEventListener('click', (e) => { e.preventDefault(); addTplItemRow({}); });
        btnTplCancel.addEventListener('click', (e) => { e.preventDefault(); closeTplEditor(); });
        btnTplSave.addEventListener('click', (e) => {
            e.preventDefault(); const name = tplName.value.trim(); if (!name) { alert('Template name is required'); return; }
            const items = collectTplItems(); if (!items.length) { alert('Add at least one item'); return; }
            post({ type: 'saveTemplate', template: { name, items } }); closeTplEditor();
        });
        btnTplDelete.addEventListener('click', (e) => {
            e.preventDefault(); const name = tplName.value.trim(); if (!name) return;
            if (confirm(`Delete template "${name}"?`)) { post({ type: 'deleteTemplate', name }); closeTplEditor(); }
        });
        tplModal.addEventListener('click', (e) => { if (e.target === tplModal) closeTplEditor(); });

        function handleWheel(e) {
            if (!pdfDoc || editingId || dragging || isFlipping) return;
            const canScroll = (container.scrollHeight - container.clientHeight) > 2;
            const nearTop = !canScroll || container.scrollTop <= 0;
            const nearBottom = !canScroll || (container.scrollTop + container.clientHeight >= container.scrollHeight - 2);
            if (e.deltaY > 0 && nearBottom && pageNum < pdfDoc.numPages) {
                e.preventDefault(); flipScrollTarget = 'top'; window.setPage(pageNum + 1);
            } else if (e.deltaY < 0 && nearTop && pageNum > 1) {
                e.preventDefault(); flipScrollTarget = 'bottom'; window.setPage(pageNum - 1);
            }
        }

        window.addEventListener('keydown', (e) => {
            const ctrl = e.ctrlKey || e.metaKey;
            if (ctrl && !e.shiftKey && (e.key === 'z' || e.key === 'Z')) { e.preventDefault(); post({ type: 'undo' }); }
            else if ((ctrl && (e.key === 'y' || e.key === 'Y')) || (ctrl && e.shiftKey && (e.key === 'z' || e.key === 'Z'))) { e.preventDefault(); post({ type: 'redo' }); }
        });


        window.setFields = function (list) {
            fields = list || [];
            selectedIds = selectedIds.filter(id => fields.some(f => f.id === id));
            redraw();
            updateSelectionActions();
            if (overlay) overlay.focus();
        };

        window.zoomIn = async function () {
            scale = Math.min(scale + 0.25, 4); pageCache = {};
            pageWrap.querySelectorAll('.page-container').forEach(el => el.remove());
            await displayPage(pageNum);
        };
        window.zoomOut = async function () {
            scale = Math.max(scale - 0.25, 0.5); pageCache = {};
            pageWrap.querySelectorAll('.page-container').forEach(el => el.remove());
            await displayPage(pageNum);
        };
        window.setTemplates = function (list) { templatesUi = list || []; renderTplBar(); };

        window.setAddedFields = function (fields) {
            const listDiv = document.getElementById('addedfieldslist');
            listDiv.innerHTML = '';

            if (!fields || fields.length === 0) {
                listDiv.innerHTML = '<div class="empty-state">No fields added.</div>';
                return;
            }

            const fieldsByPage = new Map();
            fields.forEach(field => {
                if (!fieldsByPage.has(field.page)) {
                    fieldsByPage.set(field.page, []);
                }
                fieldsByPage.get(field.page).push(field);
            });

            const sortedPages = [...fieldsByPage.keys()].sort((a, b) => a - b);

            sortedPages.forEach(page => {
                const pageFields = fieldsByPage.get(page);

                const groupDiv = document.createElement('div');
                groupDiv.className = 'field-group';

                const headerDiv = document.createElement('div');
                headerDiv.className = 'field-group-header';
                const fieldCount = pageFields.length;
                headerDiv.innerHTML = `<span class="toggle-icon">▼</span> Page ${page} (${fieldCount} field${fieldCount > 1 ? 's' : ''})`;

                const contentDiv = document.createElement('div');
                contentDiv.className = 'field-group-content';

                pageFields.sort((a, b) => a.name.localeCompare(b.name)).forEach(field => {
                    const item = document.createElement('div');
                    item.className = 'field-item';
                    item.textContent = field.name;
                    item.title = `Double-click to go to ${field.name} on Page ${field.page}`;
                    item.dataset.fieldId = field.id;
                    item.dataset.page = field.page;

                    item.addEventListener('dblclick', async () => {
                        const targetPage = parseInt(item.dataset.page, 10);
                        const fieldId = item.dataset.fieldId;
                        if (isNaN(targetPage) || !fieldId) return;

                        if (pageNum !== targetPage) {
                            await window.setPage(targetPage);
                        }
                        selectedIds = [fieldId];
                        redraw();
                        updateSelectionActions();
                        const box = overlay.querySelector(`.box[data-id="${fieldId}"]`);
                        if (box && box.scrollIntoView) {
                            box.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    });
                    contentDiv.appendChild(item);
                });

                headerDiv.addEventListener('click', () => {
                    groupDiv.classList.toggle('collapsed');
                });

                groupDiv.appendChild(headerDiv);
                groupDiv.appendChild(contentDiv);
                listDiv.appendChild(groupDiv);
            });
        };
        function setupLeftPanelDropZone() {
            const leftPanel = document.getElementById('left-panel');

            leftPanel.addEventListener('dragover', e => {
                if (currentDragDataType === 'selection') {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'copy';
                    leftPanel.classList.add('dragover');
                }
            });

            leftPanel.addEventListener('dragleave', e => {
                leftPanel.classList.remove('dragover');
            });

            leftPanel.addEventListener('drop', e => {
                e.preventDefault();
                leftPanel.classList.remove('dragover');

                if (currentDragDataType === 'selection') {
                    const data = JSON.parse(e.dataTransfer.getData('application/json'));
                    createTemplateFromFields(data);
                }
            });
        }

        function createTemplateFromFields(selectedFields) {
            const anchor = selectedFields.reduce((acc, field) => {
                const yUi = pageHeightPt() - field.y - field.h;
                const accYUi = pageHeightPt() - acc.y - acc.h;
                if (yUi < accYUi) return field;
                if (yUi === accYUi && field.x < acc.x) return field;
                return acc;
            });

            const templateItems = selectedFields.map(field => ({
                name: field.name, w: field.w, h: field.h, required: field.required,
                dx: field.x - anchor.x, dy: field.y - anchor.y
            }));

            openTplEditor({ name: '', items: templateItems });
        }

        function updateSelectionActions() {
            const leftPanelActions = document.getElementById('selection-actions');
            leftPanelActions.style.display = selectedIds.length > 0 ? 'block' : 'none';
        }

        document.getElementById('btnCreateFromSelection').addEventListener('click', () => {
            if (selectedIds.length === 0) return;
            const selectedFields = fields.filter(f => selectedIds.includes(f.id));
            createTemplateFromFields(selectedFields);
        });

        function getSelectedFields() {
            return selectedIds.map(id => fields.find(f => f.id === id)).filter(Boolean);
        }

        function commitFieldChanges(updatedFields) {
            updatedFields.forEach(f => {
                post({ type: 'updateField', id: f.id, page: pageNum, rect: { x: f.x, y: f.y, w: f.w, h: f.h } });
            });
            redraw();
        }

        function setupAlignmentActions() {
            const getAnchor = () => selectedIds.length > 0 ? fields.find(f => f.id === selectedIds[selectedIds.length - 1]) : null;

            document.getElementById('btn-match-w').addEventListener('click', () => {
                const anchor = getAnchor(); if (!anchor) return;
                const selected = getSelectedFields();
                selected.forEach(f => f.w = anchor.w);
                commitFieldChanges(selected);
            });

            document.getElementById('btn-match-h').addEventListener('click', () => {
                const anchor = getAnchor(); if (!anchor) return;
                const selected = getSelectedFields();
                selected.forEach(f => f.h = anchor.h);
                commitFieldChanges(selected);
            });

            document.getElementById('btn-match-wh').addEventListener('click', () => {
                const anchor = getAnchor(); if (!anchor) return;
                const selected = getSelectedFields();
                selected.forEach(f => { f.w = anchor.w; f.h = anchor.h; });
                commitFieldChanges(selected);
            });

            const alignFields = (edge) => {
                const anchor = getAnchor(); if (!anchor) return;
                const selected = getSelectedFields();
                selected.forEach(f => {
                    if (f.id === anchor.id) return;
                    switch (edge) {
                        case 'left': f.x = anchor.x; break;
                        case 'right': f.x = anchor.x + anchor.w - f.w; break;
                        case 'top': f.y = anchor.y; break;
                        case 'bottom': f.y = anchor.y + anchor.h - f.h; break;
                        case 'h-center': f.x = anchor.x + (anchor.w / 2) - (f.w / 2); break;
                        case 'v-center': f.y = anchor.y + (anchor.h / 2) - (f.h / 2); break;
                    }
                });
                commitFieldChanges(selected);
            };

            ['left', 'right', 'top', 'bottom', 'h-center', 'v-center'].forEach(edge => {
                document.getElementById(`btn-align-${edge}`).addEventListener('click', () => alignFields(edge));
            });

            const distributeFields = (axis) => {
                const selected = getSelectedFields();
                if (selected.length < 3) return;

                if (axis === 'v') {
                    selected.sort((a, b) => b.y - a.y);
                    const topField = selected[0], bottomField = selected[selected.length - 1];
                    const totalHeight = selected.reduce((sum, f) => sum + f.h, 0);
                    const totalSpace = topField.y + topField.h - bottomField.y;
                    const gap = (totalSpace - totalHeight) / (selected.length - 1);
                    let currentY = topField.y;
                    selected.forEach(f => { f.y = currentY; currentY -= (f.h + gap); });
                } else {
                    selected.sort((a, b) => a.x - b.x);
                    const leftField = selected[0], rightField = selected[selected.length - 1];
                    const totalWidth = selected.reduce((sum, f) => sum + f.w, 0);
                    const totalSpace = rightField.x + rightField.w - leftField.x;
                    const gap = (totalSpace - totalWidth) / (selected.length - 1);
                    let currentX = leftField.x;
                    selected.forEach(f => { f.x = currentX; currentX += f.w + gap; });
                }
                commitFieldChanges(selected);
            };

            document.getElementById('btn-dist-h').addEventListener('click', () => distributeFields('h'));
            document.getElementById('btn-dist-v').addEventListener('click', () => distributeFields('v'));
        }

        async function initializePdfViewer(pdfUrl) {
            document.body.addEventListener('dragstart', handleDragStart);
            pdfDoc = await pdfjsLib.getDocument(pdfUrl).promise;
            await buildThumbs();
            await displayPage(pageNum);
            setupLeftPanelDropZone();
            setupAlignmentActions();
        }

        (function () {
            const wrap = document.getElementById('pagewrap');
            let canvas = document.getElementById('grid-overlay');
            if (!canvas && wrap) {
                canvas = document.createElement('canvas');
                canvas.id = 'grid-overlay';
                wrap.appendChild(canvas);
            }
            const GRID_SIZE = 20;
            let gridState = 'off';

            function sizeGrid() {
                if (!wrap || !canvas) return;
                const rect = wrap.getBoundingClientRect();
                const dpr = window.devicePixelRatio || 1;
                Object.assign(canvas.style, { left: '0px', top: '0px', width: `${rect.width}px`, height: `${rect.height}px` });
                canvas.width = Math.max(1, Math.round(rect.width * dpr));
                canvas.height = Math.max(1, Math.round(rect.height * dpr));
                const ctx = canvas.getContext('2d');
                ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
                drawGrid();
            }

            function drawGrid() {
                if (!canvas || gridState === 'off') return;
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.globalAlpha = 0.15;

                if (gridState === 'line') {
                    ctx.lineWidth = 0.5;
                    ctx.strokeStyle = '#000000';
                    for (let x = 0; x < canvas.width; x += GRID_SIZE) { ctx.beginPath(); ctx.moveTo(x + 0.5, 0); ctx.lineTo(x + 0.5, canvas.height); ctx.stroke(); }
                    for (let y = 0; y < canvas.height; y += GRID_SIZE) { ctx.beginPath(); ctx.moveTo(0, y + 0.5); ctx.lineTo(canvas.width, y + 0.5); ctx.stroke(); }
                } else if (gridState === 'dot') {
                    ctx.fillStyle = '#000000';
                    const dotRadius = 0.75 * (window.devicePixelRatio || 1);
                    for (let x = GRID_SIZE; x < canvas.width; x += GRID_SIZE) {
                        for (let y = GRID_SIZE; y < canvas.height; y += GRID_SIZE) {
                            ctx.beginPath(); ctx.arc(x, y, dotRadius, 0, 2 * Math.PI); ctx.fill();
                        }
                    }
                }
                ctx.globalAlpha = 1;
            }

            window.toggleGrid = function () {
                if (!canvas) return;
                if (gridState === 'off') gridState = 'line';
                else if (gridState === 'line') gridState = 'dot';
                else gridState = 'off';
                canvas.style.display = (gridState !== 'off') ? 'block' : 'none';
                if (gridState !== 'off') sizeGrid();
                else canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
            };

            window.addEventListener('resize', sizeGrid);
            if ('ResizeObserver' in window && wrap) new ResizeObserver(sizeGrid).observe(wrap);
            if (canvas) { canvas.style.display = 'none'; sizeGrid(); }

            const tb = document.getElementById('top-toolbar');
            if (tb && wrap && tb.parentElement !== wrap) wrap.appendChild(tb);

            function positionToolbarFromDOM() {
                if (!tb || !wrap) return;
                const sel = Array.from(document.querySelectorAll('#pagewrap .box.sel'));
                if (sel.length < 2) { tb.style.display = 'none'; return; }

                const wrapRect = wrap.getBoundingClientRect();
                let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
                sel.forEach(node => {
                    const r = node.getBoundingClientRect();
                    minX = Math.min(minX, r.left - wrapRect.left); minY = Math.min(minY, r.top - wrapRect.top);
                    maxX = Math.max(maxX, r.right - wrapRect.left); maxY = Math.max(maxY, r.bottom - wrapRect.top);
                });

                tb.style.display = 'flex';
                const tbRect = tb.getBoundingClientRect();
                let left = minX + (maxX - minX) / 2 - tbRect.width / 2;
                let top = minY - tbRect.height - 8;
                left = Math.max(0, Math.min(left, wrapRect.width - tbRect.width));
                top = Math.max(0, Math.min(top, wrapRect.height - tbRect.height));
                Object.assign(tb.style, { position: 'absolute', left: `${left}px`, top: `${top}px`, transform: 'none' });
            }
            if (wrap) new MutationObserver(positionToolbarFromDOM).observe(wrap, { attributes: true, subtree: true, attributeFilter: ['class'] });

            const originalUpdateSelectionActions = window.updateSelectionActions;
            window.updateSelectionActions = function (...args) { originalUpdateSelectionActions.apply(this, args); positionToolbarFromDOM(); };

            const originalRedraw = window.redraw;
            window.redraw = function (...args) { originalRedraw.apply(this, args); positionToolbarFromDOM(); };

            window.addEventListener('resize', positionToolbarFromDOM);
            setTimeout(positionToolbarFromDOM, 50);
        })();

        function showContextMenu(event) {
            event.preventDefault();
            const box = event.target.closest('.box');
            if (!box) { hideContextMenu(); return; }

            contextMenuTargetId = box.dataset.id;
            if (!selectedIds.includes(contextMenuTargetId)) { selectedIds = [contextMenuTargetId]; redraw(); }

            const menu = document.getElementById('context-menu');
            menu.style.display = 'block';

            const { clientX: mouseX, clientY: mouseY } = event;
            const { innerWidth, innerHeight } = window;
            const { offsetWidth: menuWidth, offsetHeight: menuHeight } = menu;
            const x = mouseX + menuWidth > innerWidth ? innerWidth - menuWidth - 5 : mouseX;
            const y = mouseY + menuHeight > innerHeight ? innerHeight - menuHeight - 5 : mouseY;
            Object.assign(menu.style, { left: `${x}px`, top: `${y}px` });
        }

        function hideContextMenu() {
            const menu = document.getElementById('context-menu');
            if (menu) menu.style.display = 'none';
            contextMenuTargetId = null;
        }

        document.addEventListener('DOMContentLoaded', () => {
            const menu = document.getElementById('context-menu');
            if (!menu) return;

            menu.addEventListener('click', (e) => {
                const action = e.target.closest('li')?.dataset.action;
                if (!action || !contextMenuTargetId) { hideContextMenu(); return; }
                if (action === 'rename') beginEditName(contextMenuTargetId);
                hideContextMenu();
            });

            const cont = document.getElementById('container');
            if (cont) {
                window.addEventListener('click', hideContextMenu);
                cont.addEventListener('scroll', hideContextMenu);
            }
        });
    </script>
</body>
</html>